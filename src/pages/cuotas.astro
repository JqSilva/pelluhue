---
import Layout from '../layouts/Layout.astro';
import db from '../db/client';
import { ANIO, VALOR_CUOTA_ANUAL } from '../config';

// --- CONFIGURACI√ìN ---
const CUOTA_ANUAL = VALOR_CUOTA_ANUAL;
const MES_ACTUAL_INDEX = new Date().getMonth(); 
const CUOTA_MENSUAL = CUOTA_ANUAL / 12; 

// --- CRUD (L√≥gica intacta) ---
if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    const accion = data.get("accion"); 

    // CREAR PAGO
    if (accion === 'crear') {
        const familia_id = data.get("familia_id");
        const monto = data.get("monto");
        const mesSeleccionado = data.get("mes_pago"); 
        const fechaCompleta = `${mesSeleccionado}-01`; 

        const insert = db.prepare('INSERT INTO pagos (familia_id, monto, fecha, tipo) VALUES (?, ?, ?, ?)');
        insert.run(familia_id, monto, fechaCompleta, 'CUOTA');
    }

    // ELIMINAR PAGO
    if (accion === 'eliminar') {
        const idEliminar = data.get("pago_id");
        db.prepare('DELETE FROM pagos WHERE id = ?').run(idEliminar);
    }
    
  } catch (error) {
    console.error("Error en operaci√≥n:", error);
  }
  return Astro.redirect('/cuotas'); 
}

// INTERFACES
interface Familia { id: number; nombre: string; }
interface Pago { id: number; familia_id: number; monto: number; fecha: string; tipo?: string; }
interface PagoHistorial extends Pago { familia_nombre: string; }

// --- LECTURA ---
const familias = db.prepare('SELECT * FROM familias').all() as Familia[];
const pagosAnio = db.prepare(`SELECT * FROM pagos WHERE strftime('%Y', fecha) = ?`).all(ANIO.toString()) as Pago[];

const reporte = familias.map(f => {
    const susPagos = pagosAnio.filter(p => p.familia_id === f.id);
    let filaMeses = Array(12).fill(0);
    let totalPagado = 0;

    susPagos.forEach(p => {
        const mesIndex = new Date(p.fecha).getUTCMonth(); 
        filaMeses[mesIndex] += p.monto;
        totalPagado += p.monto;
    });

    const debioPagarHastaHoy = (MES_ACTUAL_INDEX + 1) * CUOTA_MENSUAL;
    let deudaActual = debioPagarHastaHoy - totalPagado;
    if (deudaActual < 0) deudaActual = 0; 
    if (totalPagado >= CUOTA_ANUAL) deudaActual = 0;

    return { ...f, meses: filaMeses, totalPagado, deudaTotal: CUOTA_ANUAL - totalPagado, deudaActual };
});

// C√°lculo de Totales Verticales
const totalesPorMes = Array(12).fill(0);
let granTotalPagado = 0;
let granTotalDeuda = 0;

reporte.forEach(fila => {
    fila.meses.forEach((monto, index) => { totalesPorMes[index] += monto; });
    granTotalPagado += fila.totalPagado;
    granTotalDeuda += fila.deudaActual;
});

// Datos Historial
const historialPagos = db.prepare(`
    SELECT p.id, p.monto, p.fecha, f.nombre as familia_nombre 
    FROM pagos p 
    JOIN familias f ON p.familia_id = f.id 
    WHERE strftime('%Y', p.fecha) = ?
    ORDER BY p.id DESC
`).all(ANIO.toString()) as PagoHistorial[];

const mesesNombre = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
---

<Layout title="Control de Cuotas">
    
    <div class="relative min-h-screen bg-gray-50">
        
        <div class="fixed inset-0 z-0">
        <img src="/img/caba√±a.png" class="w-full h-full object-cover" alt="Fondo Caba√±as" />
        <div class="absolute inset-0 bg-[#17253E]/85 backdrop-blur-xl"></div>
        </div>

        <div class="relative z-10 max-w-[95rem] mx-auto px-4 sm:px-6 lg:px-8 pt-40">
            
            <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
                <div>
                    <h1 class="text-4xl text-white font-anton tracking-wide uppercase drop-shadow-md">
                        Gesti√≥n de Cuotas {ANIO}
                    </h1>
                    <p class="text-blue-100 mt-2 text-lg font-light">Resumen financiero y estado de pagos por familia.</p>
                </div>
                
                <div class="flex gap-2 bg-white/10 backdrop-blur-md p-1.5 rounded-xl border border-white/20 shadow-xl">
                    <button onclick="cambiarVista('tabla')" id="btn-ver-tabla" class="px-5 py-2.5 text-sm font-medium rounded-lg transition-all text-white hover:bg-white/20 hover:cursor-pointer">
                        üìä Ver Tabla
                    </button>
                    <button onclick="cambiarVista('historial')" id="btn-ver-historial" class="px-5 py-2.5 text-sm font-medium rounded-lg transition-all text-white hover:bg-white/20 hover:cursor-pointer">
                        üìù Historial
                    </button>
                    <button onclick="cambiarVista('formulario')" class="px-4 py-2 text-sm font-medium rounded-md text-black bg-amber-400 hover:bg-amber-500 shadow-sm hover:cursor-pointer " id="btn-ver-form">

                        + Registrar Pago

                    </button>
                </div>
            </div>

            <div id="vista-tabla" class="vista-section bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden transition-all duration-300">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50/50 border-b border-gray-200">
                            <tr>
                                <th class="py-4 pl-6 pr-3 font-semibold text-gray-500 sticky left-0 bg-gray-50 z-10 border-r">Familia</th>
                                {mesesNombre.map(mes => <th class="px-2 py-4 text-center text-gray-400 text-xs uppercase font-bold">{mes}</th>)}
                                <th class="px-4 py-4 text-center text-gray-600 font-bold sticky border-l bg-gray-50/80">Pagado</th>
                                <th class="px-4 py-4 text-center text-red-600 font-bold bg-red-50/30">Deuda</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100 bg-white">
                            {reporte.map(fila => (
                                <tr class="hover:bg-blue-50/30 transition-colors">
                                    <td class="py-4 pl-6 pr-3 font-medium text-gray-900 sticky left-0 bg-white border-r shadow-[2px_0_5px_rgba(0,0,0,0.05)]">{fila.nombre}</td>
                                    {fila.meses.map(m => (
                                        <td class="px-2 py-4 text-center font-mono text-xs">
                                            {m > 0 ? <span class="text-emerald-700 font-bold bg-emerald-100/50 px-2 py-1 rounded-md shadow-sm border border-emerald-100">${m.toLocaleString('es-CL')}</span> : <span class="text-gray-200">‚Ä¢</span>}
                                        </td>
                                    ))}
                                    <td class="px-4 py-4 font-mono text-center bg-gray-50/50 font-bold sticky border-l text-gray-700">${fila.totalPagado.toLocaleString('es-CL')}</td>
                                    <td class="px-4 py-4 font-mono text-center">
                                        {fila.deudaActual > 0 
                                            ? <span class="bg-red-100 text-red-700 px-2 py-1 rounded font-bold text-xs">${fila.deudaActual.toLocaleString('es-CL')}</span>
                                            : <span class="text-green-600 font-bold text-xs">‚úì Al d√≠a</span>
                                        }
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                        <tfoot>
                            <tr class="bg-gray-100 border-t-2 border-gray-200">
                                <th class="py-4 pl-6 pr-3 font-black text-gray-800 sticky left-0 bg-gray-100 border-r">TOTALES</th>
                                {totalesPorMes.map(total => (
                                    <th class="px-2 py-4 text-center text-gray-500 font-medium text-xs">
                                        {total > 0 ? `$${total.toLocaleString('es-CL')}` : '-'}
                                    </th>
                                ))}
                                <th class="px-4 py-4 text-center font-black text-gray-800 sticky border-l bg-gray-100">${granTotalPagado.toLocaleString('es-CL')}</th>
                                <th class="px-4 py-4 text-center text-red-600 font-black bg-red-50">${granTotalDeuda.toLocaleString('es-CL')}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <div id="vista-historial" class="vista-section hidden bg-white rounded-2xl shadow-xl border border-gray-200 p-8 min-h-[500px]">
                <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    ‚è±Ô∏è Historial de Transacciones
                </h2>
                <div class="overflow-hidden rounded-xl border border-gray-200 shadow-sm">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Familia</th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Monto</th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100">
                            {historialPagos.map(pago => (
                                <tr class="hover:bg-gray-50 transition">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{new Date(pago.fecha).toLocaleDateString()}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">{pago.familia_nombre}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-mono text-emerald-600 font-bold bg-emerald-50/30">$ {pago.monto.toLocaleString('es-CL')}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center">
                                        <form method="POST">
                                            <input type="hidden" name="accion" value="eliminar" />
                                            <input type="hidden" name="pago_id" value={pago.id} />
                                            <button onclick="return confirm('¬øBorrar este pago?')" class="text-red-500 hover:text-white border border-red-200 hover:bg-red-500 text-xs font-bold px-3 py-1.5 rounded-lg transition-all shadow-sm">
                                                Eliminar
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="vista-formulario" class="vista-section hidden max-w-2xl mx-auto mt-10">
                <div class="bg-white rounded-2xl shadow-2xl border border-gray-100 p-10 relative overflow-hidden">
                    
                    
                    <h2 class="text-2xl font-bold text-gray-900 mb-8 text-center">Registrar Nuevo Pago</h2>
                    
                    <form method="POST" class="space-y-6">
                        <input type="hidden" name="accion" value="crear" /> 
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Familia</label>
                            <select name="familia_id" class="block w-full rounded-xl border-gray-300 bg-gray-50 focus:bg-white shadow-sm p-3 border focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                                {familias.map(f => <option value={f.id}>{f.nombre}</option>)}
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Mes</label>
                                <input type="month" name="mes_pago" value={`${ANIO}-${String(MES_ACTUAL_INDEX + 1).padStart(2, '0')}`} class="block w-full rounded-xl border-gray-300 bg-gray-50 focus:bg-white shadow-sm p-3 border focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Monto ($)</label>
                                <input type="number" name="monto" placeholder="15000" value=15000 class="block w-full rounded-xl border-gray-300 bg-gray-50 focus:bg-white shadow-sm p-3 border focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
                            </div>
                        </div>
                        <button type="submit" class="w-full py-4 px-4 rounded-xl text-base font-bold text-black bg-amber-400 hover:bg-amber-500 hover:cursor-pointer shadow-lg transform  transition-all">
                            Guardar Pago
                        </button>
                    </form>
                </div>
            </div>

        </div>
    </div>
</Layout>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Anton&display=swap');
    .font-anton { font-family: 'Anton', sans-serif; }
</style>

<script is:inline>
    function cambiarVista(nombreVista) {
        // 1. Ocultar todas
        document.querySelectorAll('.vista-section').forEach(el => el.classList.add('hidden'));
        // 2. Mostrar seleccionada
        document.getElementById(`vista-${nombreVista}`).classList.remove('hidden');

        // 3. Resetear botones (Estilo transparente)
        const btns = ['btn-ver-tabla', 'btn-ver-historial'];
        btns.forEach(id => {
            const btn = document.getElementById(id);
            // Reset base classes
            btn.className = "px-5 py-2.5 text-sm font-medium rounded-lg transition-all text-white hover:bg-white/20";
        });

        // 4. Activar bot√≥n actual (Estilo s√≥lido blanco)
        const btnActivo = document.getElementById(`btn-ver-${nombreVista}`);
        if(nombreVista === 'formulario') {
             // El formulario ya tiene estilo especial, lo mantenemos o forzamos
             btnActivo.className = "px-5 py-2.5 text-sm font-bold rounded-lg bg-white text-[#264E8F] shadow-sm hover:bg-gray-100 transition-all";
        } else {
             btnActivo.className = "px-5 py-2.5 text-sm font-bold rounded-lg bg-white text-[#264E8F] shadow-sm";
        }
    }
</script>