---
import Layout from '../layouts/Layout.astro';
import db from '../db/client';

// --- CRUD ---
if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    
    if (data.has("delete_id")) {
        //  ELIMINAR
        const idToDelete = data.get("delete_id");
        const deleteStmt = db.prepare('DELETE FROM familias WHERE id = ?');
        try{
            // eliminar las cuotas asociadas a esta familia
            const deleteCuotasStmt = db.prepare('DELETE FROM pagos WHERE familia_id = ?');
            deleteCuotasStmt.run(idToDelete);
            deleteStmt.run(idToDelete);
            console.log(`Familia ID ${idToDelete} eliminada.`);
        } catch (error) {
            console.error("Error al eliminar a la familia", error);
        }
        

    } else {
        // AGREGAR (no hay delete_id)
        const nombre = data.get("nombre");

        const existe = db.prepare('SELECT id FROM familias WHERE nombre = ?').get(nombre);

        if (!existe && nombre && nombre.toString().trim() !== '') {
            const insert = db.prepare('INSERT INTO familias (nombre) VALUES (?)');
            insert.run(nombre);
        }
    }

    // evitar reenvío de formularios
    return Astro.redirect('/familias'); 

  } catch (error) {
    console.error("Error procesando familia:", error);
  }
}

// --- LECTURA ---
const familias = db.prepare('SELECT * FROM familias ORDER BY id ASC').all();
---

<Layout title="Gestión de Familias">
    <div class="min-h-screen bg-gray-50 py-10 px-4">
        <div class="max-w-5xl mx-auto">
            
            <h1 class="text-2xl font-bold text-gray-900 mb-8">Directorio de Familias</h1>

            <div class="grid grid-cols-1 md:grid-cols-5 gap-8 items-start">
                
                <div class="md:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200 p-6 sticky top-8">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Agregar Nueva Familia</h2>
                    
                    <form method="POST" class="space-y-4" autocomplete="off">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Representante / Familia *</label>
                            <input 
                                type="text" 
                                name="nombre" 
                                required
                                placeholder="Ej: Familia González"
                                class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2.5 border"
                            />
                        </div>
                        <button type="submit" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-medium py-2.5 px-4 rounded-lg transition shadow-sm">
                            Guardar Familia
                        </button>
                    </form>
                </div>

                <div class="md:col-span-3 bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Familias Registradas ({familias.length})</h2>
                    </div>
                    
                    <ul class="divide-y divide-gray-100">
                        {familias.length === 0 && (
                            <li class="p-6 text-center text-gray-500 italic">No hay familias registradas aún.</li>
                        )}

                        {familias.map((familia:{id:number,nombre:string}) => (
                            <li class="p-4 hover:bg-gray-50 transition flex justify-between items-start group">
                                <div>
                                    <p class="font-medium text-gray-900 text-lg">{familia.nombre}</p>
                                </div>
                                
                                <div class="flex items-center gap-4">
                                    

                                    <form method="POST">
                                        <input type="hidden" name="delete_id" value={familia.id} />
                                        
                                        <button 
                                            type="submit" 
                                            onclick={`return confirm('¿Estás seguro de que quieres eliminar a la familia "${familia.nombre}"? Se borrará su historial de pagos.')`}
                                            class="h-8 w-8 rounded-full bg-red-50 text-red-500 hover:bg-red-100 hover:text-red-700 flex items-center justify-center font-bold transition"
                                            title="Eliminar Familia"
                                        >
                                            ✕
                                        </button>
                                    </form>
                                </div>
                            </li>
                        ))}
                    </ul>
                </div>

            </div>
        </div>
    </div>
</Layout>